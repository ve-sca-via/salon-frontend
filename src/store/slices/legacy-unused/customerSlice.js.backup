import { createSlice, createAsyncThunk } from '@reduxjs/toolkit';
import {
  getSalons,
  getSalonById,
  searchSalons,
  getMyBookings,
  createBooking,
  cancelBooking,
  addToCartAPI as addToCart,
  removeFromCartAPI as removeFromCart,
  getCart,
  checkoutCart,
  getFavorites,
  addFavorite,
  removeFavorite,
  createReview,
  getMyReviews,
  updateReview,
} from '../../services/backendApi';

// Async Thunks

// Fetch all salons
export const fetchSalonsThunk = createAsyncThunk(
  'customer/fetchSalons',
  async ({ filters = {} } = {}, { rejectWithValue }) => {
    try {
      const response = await getSalons(filters);
      return response;
    } catch (error) {
      return rejectWithValue(error.message || 'Failed to fetch salons');
    }
  }
);

// Fetch single salon details
export const fetchSalonDetailsThunk = createAsyncThunk(
  'customer/fetchSalonDetails',
  async (salonId, { rejectWithValue }) => {
    try {
      const response = await getSalonById(salonId);
      return response;
    } catch (error) {
      return rejectWithValue(error.message || 'Failed to fetch salon details');
    }
  }
);

// Search salons
export const searchSalonsThunk = createAsyncThunk(
  'customer/searchSalons',
  async ({ query, location, serviceType }, { rejectWithValue }) => {
    try {
      const response = await searchSalons({ query, location, serviceType });
      return response;
    } catch (error) {
      return rejectWithValue(error.message || 'Failed to search salons');
    }
  }
);

// Fetch customer bookings
export const fetchMyBookingsThunk = createAsyncThunk(
  'customer/fetchMyBookings',
  async (_, { rejectWithValue }) => {
    try {
      const response = await getMyBookings();
      return response;
    } catch (error) {
      return rejectWithValue(error.message || 'Failed to fetch bookings');
    }
  }
);

// Create booking
export const createBookingThunk = createAsyncThunk(
  'customer/createBooking',
  async (bookingData, { rejectWithValue }) => {
    try {
      const response = await createBooking(bookingData);
      return response;
    } catch (error) {
      return rejectWithValue(error.message || 'Failed to create booking');
    }
  }
);

// Cancel booking
export const cancelBookingThunk = createAsyncThunk(
  'customer/cancelBooking',
  async (bookingId, { rejectWithValue }) => {
    try {
      const response = await cancelBooking(bookingId);
      return { bookingId, ...response };
    } catch (error) {
      return rejectWithValue(error.message || 'Failed to cancel booking');
    }
  }
);

// Fetch cart
export const fetchCartThunk = createAsyncThunk(
  'customer/fetchCart',
  async (_, { rejectWithValue }) => {
    try {
      const response = await getCart();
      return response;
    } catch (error) {
      return rejectWithValue(error.message || 'Failed to fetch cart');
    }
  }
);

// Add to cart
export const addToCartThunk = createAsyncThunk(
  'customer/addToCart',
  async (cartItem, { rejectWithValue }) => {
    try {
      const response = await addToCart(cartItem);
      return response;
    } catch (error) {
      return rejectWithValue(error.message || 'Failed to add to cart');
    }
  }
);

// Remove from cart
export const removeFromCartThunk = createAsyncThunk(
  'customer/removeFromCart',
  async (itemId, { rejectWithValue }) => {
    try {
      await removeFromCart(itemId);
      return itemId;
    } catch (error) {
      return rejectWithValue(error.message || 'Failed to remove from cart');
    }
  }
);

// Checkout cart
export const checkoutCartThunk = createAsyncThunk(
  'customer/checkoutCart',
  async (checkoutData, { rejectWithValue }) => {
    try {
      const response = await checkoutCart(checkoutData);
      return response;
    } catch (error) {
      return rejectWithValue(error.message || 'Failed to checkout');
    }
  }
);

// Fetch favorites
export const fetchFavoritesThunk = createAsyncThunk(
  'customer/fetchFavorites',
  async (_, { rejectWithValue }) => {
    try {
      const response = await getFavorites();
      return response;
    } catch (error) {
      return rejectWithValue(error.message || 'Failed to fetch favorites');
    }
  }
);

// Add favorite
export const addFavoriteThunk = createAsyncThunk(
  'customer/addFavorite',
  async (salonId, { rejectWithValue }) => {
    try {
      const response = await addFavorite(salonId);
      return { salonId, ...response };
    } catch (error) {
      return rejectWithValue(error.message || 'Failed to add favorite');
    }
  }
);

// Remove favorite
export const removeFavoriteThunk = createAsyncThunk(
  'customer/removeFavorite',
  async (salonId, { rejectWithValue }) => {
    try {
      await removeFavorite(salonId);
      return salonId;
    } catch (error) {
      return rejectWithValue(error.message || 'Failed to remove favorite');
    }
  }
);

// Create review
export const createReviewThunk = createAsyncThunk(
  'customer/createReview',
  async (reviewData, { rejectWithValue }) => {
    try {
      const response = await createReview(reviewData);
      return response;
    } catch (error) {
      return rejectWithValue(error.message || 'Failed to create review');
    }
  }
);

// Fetch my reviews
export const fetchMyReviewsThunk = createAsyncThunk(
  'customer/fetchMyReviews',
  async (_, { rejectWithValue }) => {
    try {
      const response = await getMyReviews();
      return response;
    } catch (error) {
      return rejectWithValue(error.message || 'Failed to fetch reviews');
    }
  }
);

// Update review
export const updateReviewThunk = createAsyncThunk(
  'customer/updateReview',
  async ({ reviewId, reviewData }, { rejectWithValue }) => {
    try {
      const response = await updateReview(reviewId, reviewData);
      return { reviewId, ...response };
    } catch (error) {
      return rejectWithValue(error.message || 'Failed to update review');
    }
  }
);

// Initial State
const initialState = {
  // Salons
  salons: [],
  salonsLoading: false,
  salonsError: null,

  // Selected Salon
  selectedSalon: null,
  salonLoading: false,
  salonError: null,

  // Search
  searchResults: [],
  searchLoading: false,
  searchError: null,

  // Bookings
  myBookings: [],
  bookingsLoading: false,
  bookingsError: null,
  createBookingLoading: false,
  createBookingError: null,

  // Cart
  cartItems: [],
  cartLoading: false,
  cartError: null,
  checkoutLoading: false,
  checkoutError: null,

  // Favorites
  favorites: [],
  favoritesLoading: false,
  favoritesError: null,

  // Reviews
  myReviews: [],
  reviewsLoading: false,
  reviewsError: null,
  createReviewLoading: false,
  createReviewError: null,
};

// Customer Slice
const customerSlice = createSlice({
  name: 'customer',
  initialState,
  reducers: {
    clearSelectedSalon: (state) => {
      state.selectedSalon = null;
      state.salonError = null;
    },
    clearSearchResults: (state) => {
      state.searchResults = [];
      state.searchError = null;
    },
    clearCart: (state) => {
      state.cartItems = [];
      state.cartError = null;
    },
    clearErrors: (state) => {
      state.salonsError = null;
      state.salonError = null;
      state.searchError = null;
      state.bookingsError = null;
      state.cartError = null;
      state.favoritesError = null;
      state.reviewsError = null;
    },
  },
  extraReducers: (builder) => {
    // Fetch Salons
    builder
      .addCase(fetchSalonsThunk.pending, (state) => {
        state.salonsLoading = true;
        state.salonsError = null;
      })
      .addCase(fetchSalonsThunk.fulfilled, (state, action) => {
        state.salonsLoading = false;
        state.salons = action.payload.salons || action.payload.data?.salons || action.payload || [];
      })
      .addCase(fetchSalonsThunk.rejected, (state, action) => {
        state.salonsLoading = false;
        state.salonsError = action.payload;
      });

    // Fetch Salon Details
    builder
      .addCase(fetchSalonDetailsThunk.pending, (state) => {
        state.salonLoading = true;
        state.salonError = null;
      })
      .addCase(fetchSalonDetailsThunk.fulfilled, (state, action) => {
        state.salonLoading = false;
        state.selectedSalon = action.payload;
      })
      .addCase(fetchSalonDetailsThunk.rejected, (state, action) => {
        state.salonLoading = false;
        state.salonError = action.payload;
      });

    // Search Salons
    builder
      .addCase(searchSalonsThunk.pending, (state) => {
        state.searchLoading = true;
        state.searchError = null;
      })
      .addCase(searchSalonsThunk.fulfilled, (state, action) => {
        state.searchLoading = false;
        state.searchResults = action.payload.salons || action.payload.data?.salons || action.payload || [];
      })
      .addCase(searchSalonsThunk.rejected, (state, action) => {
        state.searchLoading = false;
        state.searchError = action.payload;
      });

    // Fetch My Bookings
    builder
      .addCase(fetchMyBookingsThunk.pending, (state) => {
        state.bookingsLoading = true;
        state.bookingsError = null;
      })
      .addCase(fetchMyBookingsThunk.fulfilled, (state, action) => {
        state.bookingsLoading = false;
        state.myBookings = action.payload.bookings || [];
      })
      .addCase(fetchMyBookingsThunk.rejected, (state, action) => {
        state.bookingsLoading = false;
        state.bookingsError = action.payload;
      });

    // Create Booking
    builder
      .addCase(createBookingThunk.pending, (state) => {
        state.createBookingLoading = true;
        state.createBookingError = null;
      })
      .addCase(createBookingThunk.fulfilled, (state, action) => {
        state.createBookingLoading = false;
        state.myBookings.unshift(action.payload);
      })
      .addCase(createBookingThunk.rejected, (state, action) => {
        state.createBookingLoading = false;
        state.createBookingError = action.payload;
      });

    // Cancel Booking
    builder
      .addCase(cancelBookingThunk.pending, (state) => {
        state.bookingsLoading = true;
      })
      .addCase(cancelBookingThunk.fulfilled, (state, action) => {
        state.bookingsLoading = false;
        const index = state.myBookings.findIndex((b) => b.id === action.payload.bookingId);
        if (index !== -1) {
          state.myBookings[index].status = 'cancelled';
        }
      })
      .addCase(cancelBookingThunk.rejected, (state, action) => {
        state.bookingsLoading = false;
        state.bookingsError = action.payload;
      });

    // Fetch Cart
    builder
      .addCase(fetchCartThunk.pending, (state) => {
        state.cartLoading = true;
        state.cartError = null;
      })
      .addCase(fetchCartThunk.fulfilled, (state, action) => {
        state.cartLoading = false;
        state.cartItems = action.payload;
      })
      .addCase(fetchCartThunk.rejected, (state, action) => {
        state.cartLoading = false;
        state.cartError = action.payload;
      });

    // Add to Cart
    builder
      .addCase(addToCartThunk.pending, (state) => {
        state.cartLoading = true;
        state.cartError = null;
      })
      .addCase(addToCartThunk.fulfilled, (state, action) => {
        state.cartLoading = false;
        state.cartItems.push(action.payload);
      })
      .addCase(addToCartThunk.rejected, (state, action) => {
        state.cartLoading = false;
        state.cartError = action.payload;
      });

    // Remove from Cart
    builder
      .addCase(removeFromCartThunk.pending, (state) => {
        state.cartLoading = true;
      })
      .addCase(removeFromCartThunk.fulfilled, (state, action) => {
        state.cartLoading = false;
        state.cartItems = state.cartItems.filter((item) => item.id !== action.payload);
      })
      .addCase(removeFromCartThunk.rejected, (state, action) => {
        state.cartLoading = false;
        state.cartError = action.payload;
      });

    // Checkout Cart
    builder
      .addCase(checkoutCartThunk.pending, (state) => {
        state.checkoutLoading = true;
        state.checkoutError = null;
      })
      .addCase(checkoutCartThunk.fulfilled, (state) => {
        state.checkoutLoading = false;
        state.cartItems = [];
      })
      .addCase(checkoutCartThunk.rejected, (state, action) => {
        state.checkoutLoading = false;
        state.checkoutError = action.payload;
      });

    // Fetch Favorites
    builder
      .addCase(fetchFavoritesThunk.pending, (state) => {
        state.favoritesLoading = true;
        state.favoritesError = null;
      })
      .addCase(fetchFavoritesThunk.fulfilled, (state, action) => {
        state.favoritesLoading = false;
        state.favorites = action.payload;
      })
      .addCase(fetchFavoritesThunk.rejected, (state, action) => {
        state.favoritesLoading = false;
        state.favoritesError = action.payload;
      });

    // Add Favorite
    builder
      .addCase(addFavoriteThunk.pending, (state) => {
        state.favoritesLoading = true;
      })
      .addCase(addFavoriteThunk.fulfilled, (state, action) => {
        state.favoritesLoading = false;
        if (!state.favorites.some((f) => f.salon_id === action.payload.salonId)) {
          state.favorites.push(action.payload);
        }
      })
      .addCase(addFavoriteThunk.rejected, (state, action) => {
        state.favoritesLoading = false;
        state.favoritesError = action.payload;
      });

    // Remove Favorite
    builder
      .addCase(removeFavoriteThunk.pending, (state) => {
        state.favoritesLoading = true;
      })
      .addCase(removeFavoriteThunk.fulfilled, (state, action) => {
        state.favoritesLoading = false;
        state.favorites = state.favorites.filter((f) => f.salon_id !== action.payload);
      })
      .addCase(removeFavoriteThunk.rejected, (state, action) => {
        state.favoritesLoading = false;
        state.favoritesError = action.payload;
      });

    // Fetch My Reviews
    builder
      .addCase(fetchMyReviewsThunk.pending, (state) => {
        state.reviewsLoading = true;
        state.reviewsError = null;
      })
      .addCase(fetchMyReviewsThunk.fulfilled, (state, action) => {
        state.reviewsLoading = false;
        state.myReviews = action.payload;
      })
      .addCase(fetchMyReviewsThunk.rejected, (state, action) => {
        state.reviewsLoading = false;
        state.reviewsError = action.payload;
      });

    // Create Review
    builder
      .addCase(createReviewThunk.pending, (state) => {
        state.createReviewLoading = true;
        state.createReviewError = null;
      })
      .addCase(createReviewThunk.fulfilled, (state, action) => {
        state.createReviewLoading = false;
        state.myReviews.unshift(action.payload);
      })
      .addCase(createReviewThunk.rejected, (state, action) => {
        state.createReviewLoading = false;
        state.createReviewError = action.payload;
      });

    // Update Review
    builder
      .addCase(updateReviewThunk.pending, (state) => {
        state.reviewsLoading = true;
      })
      .addCase(updateReviewThunk.fulfilled, (state, action) => {
        state.reviewsLoading = false;
        const index = state.myReviews.findIndex((r) => r.id === action.payload.reviewId);
        if (index !== -1) {
          state.myReviews[index] = { ...state.myReviews[index], ...action.payload };
        }
      })
      .addCase(updateReviewThunk.rejected, (state, action) => {
        state.reviewsLoading = false;
        state.reviewsError = action.payload;
      });
  },
});

export const { clearSelectedSalon, clearSearchResults, clearCart, clearErrors } =
  customerSlice.actions;

export default customerSlice.reducer;
